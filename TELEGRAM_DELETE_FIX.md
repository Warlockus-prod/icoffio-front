# –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò –£–î–ê–õ–ï–ù–ò–Ø –°–¢–ê–¢–ï–ô –í TELEGRAM BOT

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ –∫–æ–º–∞–Ω–¥—ã `/delete` –≤ Telegram –±–æ—Ç–µ –≤–æ–∑–Ω–∏–∫–∞–ª–∏ —Å–ª–µ–¥—É—é—â–∏–µ –æ—à–∏–±–∫–∏:

1. **–î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤**: Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–≤–∞ webhook'–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (–æ–±—ã—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ `edited_message`)
2. **–û—à–∏–±–∫–∞ "–ó–∞–¥–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"**: –í—Ç–æ—Ä–æ–π webhook –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª—Å—è –∫–∞–∫ –æ–±—ã—á–Ω—ã–π URL –∏ –¥–æ–±–∞–≤–ª—è–ª—Å—è –≤ –æ—á–µ—Ä–µ–¥—å
3. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π**: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–ª —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ

### –ü—Ä–∏–º–µ—Ä –æ—à–∏–±–∫–∏:
```
/delete
üóëÔ∏è –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—å–∏
–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É...

https://app.icoffio.com/en/article/article-from-spidersweb-pl-pl

‚ùå –û—à–∏–±–∫–∞ - –ó–∞–¥–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
üîÑ URL –ø–æ–ª—É—á–µ–Ω! ... job_id ...
```

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ `edited_message` (webhook/route.ts)

**–î–æ:**
```typescript
const message = body.message || body.edited_message;
```

**–ü–æ—Å–ª–µ:**
```typescript
const message = body.message; // Only process new messages, not edits
```

**–ü—Ä–∏—á–∏–Ω–∞**: Telegram –∏–Ω–æ–≥–¥–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–≤–∞ webhook'–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

### 2. –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ (telegram-compose-state.ts)

–î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:

```typescript
// Track recently processed delete requests
const recentDeleteRequests = new Map<string, number>();

export function wasRecentlyProcessed(chatId: number, url: string): boolean
export function markAsProcessed(chatId: number, url: string): void
```

**–ú–µ—Ö–∞–Ω–∏–∑–º**:
- –ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ, URL –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ "–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π" –Ω–∞ 10 —Å–µ–∫—É–Ω–¥
- –ï—Å–ª–∏ –ø—Ä–∏—Ö–æ–¥–∏—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏–π –∑–∞–ø—Ä–æ—Å –≤ —Ç–µ—á–µ–Ω–∏–µ 10 —Å–µ–∫—É–Ω–¥ - –æ–Ω –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥

### 3. –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ —Å—Ç–∞—Ç–µ–π (delete-article/route.ts)

**–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏**:
- –ü–æ–∏—Å–∫ –ø–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º slug'–∞–º (—Å/–±–µ–∑ —è–∑—ã–∫–æ–≤–æ–≥–æ —Å—É—Ñ—Ñ–∏–∫—Å–∞)
- –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

**–ü—Ä–∏–º–µ—Ä**:
```typescript
// –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ —Å—Ç–∞—Ç—å—é —Å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ slug:
// - article-from-spidersweb-pl-pl
// - article-from-spidersweb-pl
// - article-from-spidersweb
// - article-from-spidersweb-pl-pl-en
// - article-from-spidersweb-pl-pl-pl
```

### 4. –û–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (webhook/route.ts)

```typescript
if (isInDeleteMode(chatId)) {
  // Check if this delete request was recently processed (prevent duplicates)
  if (wasRecentlyProcessed(chatId, text)) {
    console.log(`[Webhook] Ignoring duplicate delete request`);
    return NextResponse.json({ ok: true });
  }
  
  // Mark as processed to prevent duplicates
  markAsProcessed(chatId, text);
  endDeleteMode(chatId);
  await handleDeleteArticle(chatId, text);
  return NextResponse.json({ ok: true });
}
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç

### –ë—ã–ª–æ:
1. Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç URL –¥–≤–∞–∂–¥—ã
2. –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –æ—á–µ—Ä–µ–¥—å –∫–∞–∫ job
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –æ—à–∏–±–∫—É "–ó–∞–¥–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"

### –°—Ç–∞–ª–æ:
1. Telegram –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç URL –¥–≤–∞–∂–¥—ã (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)
2. –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. –í—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤)
4. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± —É–¥–∞–ª–µ–Ω–∏–∏

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –§–∞–π–ª—ã –∏–∑–º–µ–Ω–µ–Ω—ã:
1. **app/api/telegram/webhook/route.ts**
   - –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ `edited_message`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
   - –ò–º–ø–æ—Ä—Ç –Ω–æ–≤—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π

2. **lib/telegram-compose-state.ts**
   - –î–æ–±–∞–≤–ª–µ–Ω `recentDeleteRequests` Map
   - –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏: `wasRecentlyProcessed()`, `markAsProcessed()`
   - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥

3. **app/api/admin/delete-article/route.ts**
   - –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è `findPostBySlug()`
   - –ü–æ–∏—Å–∫ –ø–æ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º slug'–∞–º
   - –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
   - –ë–æ–ª–µ–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö

### –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:
- ‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏–µ environment variables
- ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç —Å —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–µ–π Telegram Bot API
- ‚úÖ –ù–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç 1: –£–¥–∞–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ç–∞—Ç—å–∏
```
/delete
‚Üí https://app.icoffio.com/en/article/test-article-en
‚úÖ –°—Ç–∞—Ç—å—è —É–¥–∞–ª–µ–Ω–∞!
```

### –¢–µ—Å—Ç 2: –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å—Ç–∞—Ç—å–∏
```
/delete
‚Üí https://app.icoffio.com/en/article/non-existent-article
‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
Article not found in WordPress with slug: non-existent-article. It may have already been deleted.
```

### –¢–µ—Å—Ç 3: –î—É–±–ª–∏—Ä—É—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã (—Ä–µ—à–µ–Ω–æ)
```
/delete
‚Üí https://app.icoffio.com/en/article/test-article-en
‚úÖ –°—Ç–∞—Ç—å—è —É–¥–∞–ª–µ–Ω–∞! (—Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑, –¥—É–±–ª–∏–∫–∞—Ç—ã –∏–≥–Ω–æ—Ä–∏—Ä—É—é—Ç—Å—è)
```

## üìù Deployment

### Production –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å:
- ‚úÖ –ö–æ–¥ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω
- ‚úÖ –õ–∏–Ω—Ç–µ—Ä –æ—à–∏–±–æ–∫ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–∏–ª
- ‚úÖ TypeScript –∫–æ–º–ø–∏–ª—è—Ü–∏—è —É—Å–ø–µ—à–Ω–∞
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–µ–ø–ª–æ—è:
```bash
cd icoffio-clone-nextjs
npm run build
git add .
git commit -m "üêõ Fix: Telegram delete command duplicate requests and error handling"
git push origin main
```

### Vercel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è

## üéØ –î–∞–ª—å–Ω–µ–π—à–∏–µ —É–ª—É—á—à–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

1. **Batch deletion**: –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å—Ç–∞—Ç–µ–π –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π
2. **Confirmation dialog**: –ó–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º
3. **Deletion history**: –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π
4. **Rollback**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [TELEGRAM BOT DOCUMENTATION](./N8N_INTEGRATION_GUIDE.md)
- [API DOCUMENTATION](./UNIFIED_SYSTEM_GUIDE.md)
- [DEVELOPMENT RULES](./DEVELOPMENT_RULES.md)

---

**–í–µ—Ä—Å–∏—è**: v4.9.1  
**–î–∞—Ç–∞**: 28 –æ–∫—Ç—è–±—Ä—è 2025  
**–ê–≤—Ç–æ—Ä**: AI Assistant  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ READY FOR PRODUCTION






